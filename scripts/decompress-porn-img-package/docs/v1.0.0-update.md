# v1.0.0 破坏性变更说明

## 1. 变更概览

本次将 `@ruan-cat/decompress-porn-img-package` 从 `v0.1.0` 升级至 `v1.0.0`，属于**破坏性变更**。主要包括以下内容：

1. 代码架构从单文件重构为模块化多文件结构
2. 新增细粒化的文件夹编号范围处理能力
3. 新增智能识别处理阶段的能力
4. CLI 入口与库入口分离
5. 引入 `changelogen` 作为版本升级与日志生成工具

## 2. 破坏性变更（Breaking Changes）

### 2.1 CLI 入口变更

`bin` 字段从 `dist/index.mjs` 迁移到 `dist/cli.mjs`。使用 `pnpm exec decompress-porn-img-package` 或 `pnpm exec dpip` 命令调用不受影响，但如果有脚本直接引用 `dist/index.mjs` 作为可执行文件则需要更新。

### 2.2 代码结构重构

原有的单文件 `src/index.ts`（357 行）已拆分为 10 个独立模块：

|           文件            |             职责             |
| :-----------------------: | :--------------------------: |
|      `src/types.ts`       |           类型定义           |
|      `src/config.ts`      |       配置加载与默认值       |
|  `src/define-config.ts`   |   `defineConfig` 辅助函数    |
|    `src/file-utils.ts`    |       文件操作工具函数       |
|     `src/archive.ts`      |        压缩包处理逻辑        |
|  `src/phase-detector.ts`  |        智能阶段识别器        |
| `src/folder-organizer.ts` |   已解压文件夹目录层级整理   |
|    `src/processor.ts`     |        主处理流程编排        |
|       `src/cli.ts`        |           CLI 入口           |
|      `src/index.ts`       | 库入口（纯导出 barrel 文件） |

### 2.3 类型变更

`ToolConfig` 类型新增 `folderRange` 可选字段。原有字段完全保持不变。

```typescript
export type ToolConfig = {
	/** 原有字段保持不变 */
	password?: string;
	dirtyFiles?: string[];
	isPureDecompress?: boolean;
	isDecompressMixedNamedPackages?: boolean;
	isDeletePackages?: boolean;
	isMoveFilesToRoot?: boolean;
	isRenameRootFolder?: boolean;
	/** 新增：要处理的文件夹/文件编号范围 */
	folderRange?: FolderRange;
};

export type FolderRange = {
	start: number;
	end: number;
};
```

## 3. 新增功能

### 3.1 细粒化的文件夹编号范围处理

通过配置 `folderRange` 字段，可以仅处理指定编号范围内的文件夹或压缩包：

```typescript
import { defineConfig } from "@ruan-cat/decompress-porn-img-package";

export default defineConfig({
	password: "https://www.91xiezhen.top",
	dirtyFiles: ["孔雀海"],
	isMoveFilesToRoot: true,
	isRenameRootFolder: true,
	/** 仅处理编号 213 ～ 228 的文件夹/压缩包 */
	folderRange: { start: 213, end: 228 },
});
```

不配置 `folderRange` 时，保持原有行为——处理目录下所有符合规则的压缩包。

### 3.2 智能识别处理阶段

当配置了 `folderRange` 后，工具会对范围内每个编号进行智能识别：

1. **编号对应压缩包**（如 `221.gz`、`222.zip`）→ 走**解压流程**（与原有完整流程一致）
2. **编号对应文件夹**（如 `213/`）→ 走**整理流程**（扁平化目录层级、移动文件、清理空目录）
3. **都不存在** → 跳过该编号

这使得工具可以自动区分和处理混合场景——同一目录下既有需要解压的压缩包，又有需要整理的已解压文件夹。

### 3.3 文件夹目录层级整理

针对已解压但目录层级过深的文件夹，新增 `organizeFolder` 函数：

- 自动检测多层嵌套的同名目录结构
- 将最深层的内容文件（图片等）提升到编号根目录
- 清理多余的嵌套空目录
- 删除脏文件
- 可选用检测到的名称重命名根目录

## 4. 处理模式说明

### 4.1 全量模式（原有行为）

不配置 `folderRange` 时生效。处理目标目录下所有符合命名规则的压缩包文件。

```plain
📦 全量处理模式: 处理目录下所有压缩包
```

### 4.2 范围模式（新增）

配置 `folderRange` 后生效。仅处理指定范围内的编号，并智能识别每个编号的处理阶段。

```plain
🎯 范围处理模式: 编号 213 ~ 228
  编号 213: 📁 文件夹 → 整理流程
  编号 214: 📁 文件夹 → 整理流程
  ...
  编号 221: 📦 压缩包 → 解压流程
  编号 222: 📦 压缩包 → 解压流程
  ...
```

## 5. 版本管理工具

本包引入 `changelogen` 作为版本升级与更新日志生成工具。

参考文章：[对 changelogen 和 changelogithub 使用的思考](https://juejin.cn/post/7572095192417828891)

### 5.1 可用命令

```bash
## 生成更新日志（仅输出）
pnpm run changelog

## 版本升级 + 日志生成 + 推送（完整发版流程）
pnpm run release
```

### 5.2 选择 changelogen 的理由

根据参考文章的结论，对于单人维护的 GitHub 小项目，`changelogen` 方案具有以下优势：

- 本地能生成工整美观的 `CHANGELOG.md` 文件
- 同时支持 GitHub Release 日志
- 语义化版本号自动管理
- 配置简单，一个命令完成版本升级 + 日志生成 + 推送

## 6. 迁移指南

### 6.1 从 v0.1.0 迁移到 v1.0.0

1. **配置文件无需修改**：原有的 `decompress-porn-img-package.config.ts` 配置完全兼容
2. **新增配置项可选**：`folderRange` 是新增的可选字段，不配置时保持原有行为
3. **重新安装依赖**：运行 `pnpm install` 以触发 `postinstall` 重新构建
